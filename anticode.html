<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        // Emergency Debugger for Android/Older browsers
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            var string = msg.toLowerCase();
            var message = [
                'Message: ' + msg,
                'URL: ' + url,
                'Line: ' + lineNo,
                'Column: ' + columnNo,
                'Error object: ' + JSON.stringify(error)
            ].join(' - ');
            alert("Error detected: " + message);
            return false;
        };
        window.onunhandledrejection = function (event) {
            alert("Promise Rejection: " + event.reason);
        };
    </script>
    <meta name="description" content="ROSAE HUB 실시간 채팅 커뮤니티. 나노 도로시와 함께하는 소통의 공간.">
    <meta name="keywords"
        content="ROSAE HUB Chat, RosaeHub 채팅, 나노도로시 채팅, 실시간 채팅, 웹 메신저, 익명 채팅, 커뮤니티 채팅, Web Chat, Messenger, Community Chat, Nanodoroshi Chat">
    <title>ROSAE HUB | Nanodoroshi Community</title>
    <link rel="stylesheet" href="style.css?v=2026.01.28.2015">
    <link rel="stylesheet" href="anticode.css?v=2026.01.28.2015">
    <link rel="manifest" href="/manifest-v3.json?v=3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ROSAE HUB">
    <meta name="theme-color" content="#ffb92f">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Noto+Sans+KR:wght@300;400;700;900&display=swap"
        rel="stylesheet">
    <style>
        /* Server Maintenance & Update UI */
        #maintenance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 16, 0.98);
            color: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
        }

        #maintenance-overlay h1 {
            color: #ffb92f;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 185, 47, 0.5);
        }

        #maintenance-overlay p {
            font-size: 1.1rem;
            opacity: 0.8;
            line-height: 1.6;
        }

        #update-notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffb92f;
            color: black;
            padding: 15px 25px;
            border-radius: 12px;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 10002;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            font-weight: bold;
            animation: slideUp 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        @keyframes slideUp {
            from {
                bottom: -100px;
                opacity: 0;
            }

            to {
                bottom: 80px;
                opacity: 1;
            }
        }

        #update-notification button {
            background: black;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        #update-notification button:hover {
            transform: scale(1.05);
            background: #333;
        }
    </style>
</head>

<body class="anticode-body">
    <!-- Maintenance & Update UI -->
    <div id="maintenance-overlay">
        <h1>🚧 ROSAE HUB MAINTENANCE</h1>
        <p>현재 서버 점검 중이거나 데이터베이스 연결이 원활하지 않습니다.<br>잠시 후 다시 시도해 주세요.</p>
    </div>
    <div id="update-notification">
        <span>앱 업데이트가 필요합니다.</span>
        <button onclick="location.reload()">재시작</button>
    </div>

    <div id="anticode-container">
        <!-- Sidebar: Channels -->
        <aside class="anticode-sidebar">
            <div class="sidebar-header">
                <button class="sidebar-close-btn" title="닫기">←</button>
                <h2>ROSAE HUB</h2>
            </div>

            <!-- Profile Section (Interactive) -->
            <div class="user-profile-section" id="current-user-info">
                <!-- User info & UID rendered here by JS -->
            </div>
            <div class="sidebar-settings">
                <button id="open-settings-btn" class="settings-cog-btn" title="설정">⚙️</button>
            </div>

            <div class="channel-list-container">
                <!-- Group: Friends -->
                <div class="channel-group">
                    <div class="group-header">
                        <span class="group-label">친구 목록</span>
                        <button id="open-add-friend" class="add-channel-btn">친구추가</button>
                    </div>
                    <ul id="friend-list" class="sidebar-list">
                        <!-- Friends rendered here -->
                    </ul>
                </div>

                <!-- Group: Channels by Category -->
                <div class="channel-group">
                    <div class="group-header">
                        <span class="group-label">채널 목록</span>

                    </div>
                    <div class="channel-page-bar">
                        <select id="channel-page-select" class="channel-page-select" title="내 채널 만들기">
                            <option value="all">전체 채널</option>
                        </select>
                        <button id="open-channel-pages" class="notif-toggle-btn"
                            style="padding:6px 10px; font-size:0.72rem; white-space:nowrap;">내 개인 채널 만들기</button>
                    </div>
                    <div id="categorized-channels">
                        <!-- Categories and channels rendered dynamically -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main: Chat Area -->
        <main class="anticode-chat-area">
            <header class="chat-header">
                <div class="header-left">
                    <button id="mobile-menu-toggle" class="mobile-only-btn">☰</button>
                    <span class="channel-hash">#</span>
                    <h1 id="current-channel-name">일상-채팅</h1>
                </div>
                <div class="header-right">
                    <button id="mobile-more-btn" class="mobile-only-btn">⋮</button>
                    <div id="mobile-dropdown-menu" class="mobile-dropdown-content" style="display:none;">
                        <button id="menu-channels">💬 채널 목록</button>
                        <button id="menu-friends">👤 친구 관리</button>
                        <button id="menu-members">👥 멤버 목록 (온라인 상태)</button>
                        <button id="menu-pages">📄 내 채널 만들기</button>
                        <!-- menu-add removed -->
                        <button id="menu-profile">⚙️ 프로필 설정</button>
                        <button id="menu-blocked-list">🚫 차단한 유저 목록</button>
                        <button onclick="window.location.href='index.html'" id="menu-back">↩️ 블로그로 돌아가기</button>
                        <button onclick="toggleNotifSound()" class="notif-toggle-btn notif-sound-toggle">🔔 알림 소리
                            ON</button>
                    </div>
                </div>
            </header>

            <div id="blocked-list-modal" class="modal-overlay" style="display:none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>차단한 유저 목록</h2>
                        <button id="close-blocked-modal" class="close-btn">&times;</button>
                    </div>
                    <div id="blocked-users-container" class="blocked-list-container">
                        <!-- Blocked users will be listed here -->
                    </div>
                </div>
            </div>

            <div id="message-container" class="message-container">
                <div class="chat-welcome">
                    <h1>ROSAE HUB에 오신 것을 환영합니다!</h1>
                    <p>커뮤니티의 시작점입니다. 메시지를 남겨보세요.</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <button id="emoji-btn" class="emoji-trigger-btn">😀</button>
                    <button id="attach-btn" class="emoji-trigger-btn">📎</button>
                    <input type="file" id="chat-file-input"
                        accept="image/*,.txt,text/plain,.zip,application/zip,application/x-zip-compressed"
                        style="display:none;">
                    <textarea id="chat-input" placeholder="메시지 보내기..." rows="1"></textarea>

                    <!-- Emoji Picker Popover -->
                    <div id="emoji-picker" class="emoji-picker-popover" style="display:none;">
                        <div class="emoji-picker-tabs">
                            <div class="emoji-picker-tab active" onclick="window.app.switchEmojiTab('unicode', event)">
                                이모지
                            </div>
                            <div class="emoji-picker-tab" onclick="window.app.switchEmojiTab('custom', event)">이모티콘
                            </div>
                        </div>
                        <div id="emoji-content-unicode" class="emoji-content-area emoji-grid">
                            <span class="emoji-item">😀</span><span class="emoji-item">😂</span><span
                                class="emoji-item">🥰</span>
                            <span class="emoji-item">😎</span><span class="emoji-item">🤔</span><span
                                class="emoji-item">👍</span>
                            <span class="emoji-item">❤️</span><span class="emoji-item">🔥</span><span
                                class="emoji-item">✨</span>
                            <span class="emoji-item">🎉</span><span class="emoji-item">😭</span><span
                                class="emoji-item">👀</span>
                            <span class="emoji-item">🙏</span><span class="emoji-item">🙌</span><span
                                class="emoji-item">🚀</span>
                            <span class="emoji-item">💡</span><span class="emoji-item">💪</span><span
                                class="emoji-item">👏</span>
                            <span class="emoji-item">💯</span><span class="emoji-item">🌹</span><span
                                class="emoji-item">✅</span>
                            <span class="emoji-item">❌</span><span class="emoji-item">❓</span><span
                                class="emoji-item">🎵</span>
                        </div>
                        <div id="emoji-content-custom" class="emoji-content-area emoticon-grid" style="display:none;">
                            <!-- Filled dynamically by JS -->
                        </div>
                    </div>

                    <div class="input-actions">
                        <button id="send-msg-btn">전송</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right: Member List -->
        <aside class="anticode-members">
            <div class="members-header">
                <span>온라인 — <span id="online-count">0</span></span>
                <button id="toggle-members-btn" class="members-toggle-btn" title="접기/펴기">▼</button>
            </div>
            <div id="member-list" class="member-list">
                <!-- Member items rendered here -->
            </div>
        </aside>
    </div>


    <!-- Create Channel Modal -->
    <div id="create-channel-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>채널 생성</h2>
            <form id="create-channel-form">
                <div class="form-group">
                    <label>채널 이름</label>
                    <input type="text" id="new-channel-name" required placeholder="예: 축구-채팅">
                </div>
                <div class="form-group">
                    <label>채널 유형</label>
                    <select id="new-channel-type">
                        <option value="notice">📢 공지사항 (공식 알림)</option>
                        <option value="general">일반 채팅</option>
                        <option value="secret">비밀 채팅 (비밀번호)</option>
                        <option value="open_hidden">오픈 채팅 (초대 전용)</option>
                        <option value="qna">질문 답변</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>카테고리</label>
                    <select id="new-channel-category">
                        <option value="notice">공지사항</option>
                        <option value="chat">채팅방</option>
                        <option value="karaoke">노래방</option>
                        <option value="voice">보이스 톡</option>
                        <option value="game">게임 방</option>
                    </select>
                </div>
                <div id="password-field-group" class="form-group" style="display:none;">
                    <label>방 비밀번호</label>
                    <input type="password" id="new-channel-password" placeholder="숫자 4자리 권장">
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">생성</button>
                    <button type="button" id="close-channel-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="add-friend-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>친구 추가</h2>
            <form id="add-friend-form">
                <div class="form-group">
                    <label>친구 UID 코드</label>
                    <input type="text" id="friend-uid-input" required placeholder="예: 123456" maxlength="6">
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">추가</button>
                    <button type="button" id="close-friend-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Friend List Modal (Full list + invite) -->
    <div id="friend-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>👤 친구 목록</h2>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">
                친구를 선택해서 현재 채널로 초대할 수 있습니다.
            </p>
            <div id="friend-modal-list"
                style="max-height: 260px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
            </div>
            <div class="modal-btns">
                <button type="button" id="close-friend-list-modal" class="submit-btn">확인</button>
            </div>
        </div>
    </div>

    <!-- Channel Pages / Directory Modal -->
    <div id="channel-pages-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>📄 내 채널 만들기</h2>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px; display:none;">
                유저별로 채널 목록을 커스텀(눈속임)하고, 채널 위치를 검색/초대할 수 있습니다.
            </p>
            <div id="pages-personal-pane">
                <div class="form-group" style="display:none;">
                    <label>페이지 선택</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select id="pages-modal-select" style="flex:1;"></select>
                        <button type="button" id="pages-modal-delete" class="notif-toggle-btn"
                            style="white-space:nowrap;">삭제</button>
                    </div>
                </div>
                <div class="form-group" style="display:none;">
                    <label>페이지 이름 변경</label>
                    <div style="display:flex; gap:10px;">
                        <input id="pages-modal-rename" type="text" placeholder="선택한 페이지 새 이름" style="flex:1;">
                        <button type="button" id="pages-modal-rename-btn" class="notif-toggle-btn"
                            style="white-space:nowrap;">변경</button>
                    </div>
                    <small style="color: var(--text-muted); font-size: 0.7rem;">8글자 이상은 목록에서 …로 표시됩니다.</small>
                </div>
                <div class="form-group">
                    <label>내 채널 만들기</label>
                    <div style="display:flex; gap:10px;">
                        <input id="pages-modal-new-name" type="text" placeholder="예: 내 즐겨찾기" style="flex:1;">
                        <button type="button" id="pages-modal-create" class="submit-btn">생성</button>
                    </div>
                </div>
                <!-- NEW: Manage Channels I Created -->
                <div id="pages-owned-channels-section" class="form-group">
                    <label>내가 만든 채널 관리 (삭제)</label>
                    <div id="pages-modal-owned-list" class="owned-channels-container">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="form-group" style="display:none;">
                    <label>채널 검색/추가</label>
                    <input id="pages-modal-search" type="text" placeholder="채널 이름/카테고리로 검색 (예: chat, 공지, 노래방)">
                    <div id="pages-modal-results"
                        style="max-height: 220px; overflow-y:auto; margin-top:10px; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 8px;">
                    </div>
                </div>
                <div class="form-group" style="display:none;">
                    <label>이 페이지에 포함된 채널</label>
                    <div id="pages-modal-items"
                        style="max-height: 220px; overflow-y:auto; border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 8px;">
                    </div>
                    <small style="color: var(--text-muted); font-size: 0.7rem;">드래그로 순서를 변경할 수 있습니다.</small>
                </div>
            </div>
            <div class="modal-btns">
                <button type="button" id="close-channel-pages-modal" class="submit-btn">확인</button>
            </div>
        </div>
    </div>

    <!-- Password Entry Modal -->
    <div id="password-entry-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>비밀 채팅방 입장</h2>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">이 방은 비밀번호가 설정되어 있습니다.</p>
            <form id="password-entry-form">
                <div class="form-group">
                    <label>비밀번호</label>
                    <input type="password" id="entry-password-input" required autofocus>
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">입장</button>
                    <button type="button" id="close-password-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>프로필 설정</h2>
            <form id="profile-form">
                <div class="form-group">
                    <label>닉네임</label>
                    <input type="text" id="edit-nickname" required>
                </div>
                <div class="form-group">
                    <label>프로필 이미지</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="url" id="edit-avatar-url" placeholder="https://example.com/photo.jpg"
                            style="flex: 1;">
                        <button type="button" id="upload-avatar-btn" class="sm-btn"
                            style="white-space: nowrap; font-size: 0.7rem;">파일 선택</button>
                    </div>
                    <input type="file" id="avatar-file-input" accept="image/*" style="display:none;">
                    <small style="color: var(--text-muted); font-size: 0.65rem;">직접 올리거나 주소를 입력하세요. (1:1 비율 권장)</small>
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">저장</button>
                    <button type="button" id="close-profile-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Card Modal (View any user's profile) -->
    <div id="profile-card-modal" class="modal-overlay" style="display:none;">
        <div class="profile-card-content">
            <button id="close-profile-card" class="profile-card-close">&times;</button>
            <div class="profile-card-avatar-wrapper">
                <img id="profile-card-avatar" src="" alt="Avatar" class="profile-card-avatar">
            </div>
            <h3 id="profile-card-nickname" class="profile-card-name">닉네임</h3>
            <div id="profile-card-uid" class="profile-card-uid">UID: 000000</div>
            <div class="profile-card-bio-section">
                <label class="profile-card-bio-label">자기소개</label>
                <textarea id="profile-card-bio" class="profile-card-bio" placeholder="자기소개가 없습니다." readonly></textarea>
            </div>
            <div id="profile-card-actions" class="profile-card-actions" style="display:none;">
                <button id="profile-card-save" class="submit-btn">저장</button>
            </div>
        </div>
    </div>
    <!-- App Settings Modal -->
    <div id="app-settings-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>⚙️ 환경 설정</h2>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">👤 내 프로필</span>
                    <span class="label-desc">닉네임과 프로필 이미지를 변경합니다.</span>
                </div>
                <button type="button" id="open-profile-edit-btn" class="notif-toggle-btn">프로필 설정</button>
            </div>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">🔔 알림 소리</span>
                    <span class="label-desc">새 메시지 도착 시 소리로 알립니다.</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button onclick="toggleNotifSound()" id="notif-toggle-settings"
                        class="notif-toggle-btn notif-sound-toggle">🔔 ON</button>
                    <button type="button" id="notif-os-permission" class="notif-toggle-btn">OS 알림 허용</button>
                    <button type="button" id="notif-test-btn" class="notif-toggle-btn">알림 테스트</button>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-top:10px; width:100%;">
                    <div style="min-width:110px; color:var(--text-muted); font-size:0.75rem; font-weight:700;">알림 볼륨
                    </div>
                    <input id="notif-volume" type="range" min="0" max="100" step="5" value="80" style="flex:1;">
                    <span id="notif-volume-value"
                        style="min-width:48px; text-align:right; color:var(--text-muted); font-size:0.75rem;">80%</span>
                </div>
            </div>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">📲 푸시 알림 (오프라인)</span>
                    <span class="label-desc">브라우저를 완전히 닫아도 OS 푸시 알림을 받습니다. (PC/모바일)</span>
                    <span id="push-status" class="label-desc" style="margin-top:4px;">상태: -</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <button type="button" id="push-enable-btn" class="notif-toggle-btn">푸시 켜기</button>
                    <button type="button" id="push-disable-btn" class="notif-toggle-btn">푸시 끄기</button>
                    <button type="button" id="push-test-btn" class="notif-toggle-btn">푸시 테스트</button>
                </div>
            </div>
            <div id="chat-cleanup-setting" class="setting-item-group" style="display:none;">
                <div class="setting-label">
                    <span class="label-title">🧹 채팅 기록 정리</span>
                    <span class="label-desc">90일(3개월)보다 오래된 메시지를 삭제합니다. (관리자 전용)</span>
                    <span id="chat-cleanup-last-run" class="label-desc" style="margin-top:4px;">마지막 실행: -</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button type="button" id="chat-cleanup-toggle" class="notif-toggle-btn">🔔 ON</button>
                    <button type="button" id="chat-cleanup-run-now" class="notif-toggle-btn">지금 실행</button>
                </div>
            </div>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">🎙️ 마이크(입력 장치)</span>
                    <span class="label-desc">USB 마이크를 재설정/선택할 수 있습니다. (보이스 톡 사용 전 권장)</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center; width:100%;">
                    <select id="voice-mic-select" style="flex:1; min-width: 0;">
                        <option value="">기본 마이크</option>
                    </select>
                    <button type="button" id="voice-mic-refresh" class="notif-toggle-btn">새로고침</button>
                    <button type="button" id="voice-mic-apply" class="notif-toggle-btn">적용</button>
                </div>
            </div>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">🧪 마이크 테스트</span>
                    <span class="label-desc">내 마이크 소리가 들리는지 확인하고(테스트 중에는 스피커로 출력), 입력 레벨을 확인할 수 있습니다.</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center; width:100%; flex-wrap:wrap;">
                    <button type="button" id="voice-mic-test-toggle" class="notif-toggle-btn">마이크 OFF</button>
                    <div class="mic-meter" title="마이크 입력 레벨">
                        <div id="voice-mic-meter-bar" class="mic-meter-bar" style="width:0%"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-top:10px; width:100%;">
                    <div style="min-width:110px; color:var(--text-muted); font-size:0.75rem; font-weight:700;">마이크 볼륨
                    </div>
                    <input id="voice-mic-gain" type="range" min="0" max="200" step="5" value="100" style="flex:1;">
                    <span id="voice-mic-gain-value"
                        style="min-width:48px; text-align:right; color:var(--text-muted); font-size:0.75rem;">100%</span>
                </div>
            </div>
            <div class="modal-btns">
                <button type="button" id="close-settings-modal" class="submit-btn">확인</button>
            </div>
        </div>
    </div>



    <!-- Auth Guard -->
    <div id="auth-guard" class="auth-guard" style="display:none;">
        <div class="guard-content">
            <h2>로그인이 필요합니다</h2>
            <p>ROSAE HUB를 이용하시려면 먼저 블로그에 로그인해 주세요.</p>
            <button onclick="location.href='index.html'">로그인하러 가기</button>
        </div>
    </div>

    <!-- Real-time Notification UI -->
    <div id="inapp-notif-toast" class="inapp-notif-toast" style="display:none;">
        <div class="toast-title">ROSAE HUB</div>
        <div id="inapp-notif-toast-body" class="toast-body">알림</div>
    </div>
    <div id="notif-badge" class="notif-badge" onclick="clearNotifications()">
        <span class="notif-icon">🔔</span>
        <span id="notif-count-display" class="notif-count" style="display:none;">0</span>
    </div>
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <script type="module" src="anticode.js?v=2026.01.28.2015"></script>
    <script>
        // [ANTI-GRAVITY] Robust PWA Update Logic
        let currentVersion = null; // Will store local version from version.json if possible, or script tag

        async function checkForUpdate() {
            try {
                // 1. Fetch remote version.json (bypass cache)
                const res = await fetch('./version.json?t=' + Date.now());
                if (!res.ok) return;
                const data = await res.json();
                const latestVersion = data.version;

                // 2. Get local version (from meta tag or initial fetch)
                // For now, we assume if we have a version mismatch, we update.
                // You might store the "current" version in localStorage on load.
                const storedVersion = localStorage.getItem('app_version');

                if (storedVersion && storedVersion !== latestVersion) {
                    console.log(`Update detected: ${storedVersion} -> ${latestVersion}`);
                    showUpdateNotification();
                }

                // Update local storage to latest after check (so we don't loop forever unless page reloads)
                if (!storedVersion) {
                    localStorage.setItem('app_version', latestVersion);
                }
            } catch (e) {
                console.warn('Update check failed:', e);
            }
        }

        function showUpdateNotification() {
            const el = document.getElementById('update-notification');
            if (el) {
                el.style.display = 'flex';
                // Click handler is already inline: onclick="location.reload()"
                // But let's make it robust by clearing cache just in case
                const btn = el.querySelector('button');
                if (btn) btn.onclick = () => {
                    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                        // Signal SW to skip waiting
                        navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                    }
                    // Hard reload
                    window.location.reload(true);
                };
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('PWA Service Worker registered');

                        // Check for updates periodically
                        setInterval(() => reg.update(), 60 * 60 * 1000); // Check SW every hour
                        setInterval(checkForUpdate, 5 * 60 * 1000); // Check version.json every 5 mins

                        // Initial check
                        checkForUpdate();

                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New update available
                                        console.log('New SW version installed (waiting to activate)');
                                        showUpdateNotification();
                                    } else {
                                        console.log('Content is cached for offline use.');
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => console.error('PWA Service Worker registration failed', err));
            });

            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        }
    </script>
</body>

</html>