<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AntiCode | Nanodoroshi Community</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="anticode.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Noto+Sans+KR:wght@300;400;700;900&display=swap"
        rel="stylesheet">
</head>

<body class="anticode-body">
    <div id="anticode-container">
        <!-- Sidebar: Channels -->
        <aside class="anticode-sidebar">
            <div class="sidebar-header">
                <h2>ANTICODE</h2>
            </div>

            <!-- Profile Section (Interactive) -->
            <div class="user-profile-section" id="current-user-info">
                <!-- User info & UID rendered here by JS -->
            </div>
            <div class="sidebar-settings">
                <button id="open-settings-btn" class="settings-cog-btn" title="설정">⚙️</button>
            </div>

            <div class="channel-list-container">
                <!-- Group: Friends -->
                <div class="channel-group">
                    <div class="group-header">
                        <span class="group-label">친구 목록</span>
                        <button id="open-add-friend" class="add-channel-btn">+</button>
                    </div>
                    <ul id="friend-list" class="sidebar-list">
                        <!-- Friends rendered here -->
                    </ul>
                </div>

                <!-- Group: Channels by Category -->
                <div class="channel-group">
                    <div class="group-header">
                        <span class="group-label">채널 목록</span>
                        <button id="open-create-channel" class="add-channel-btn">+</button>
                    </div>
                    <div id="categorized-channels">
                        <!-- Categories and channels rendered dynamically -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main: Chat Area -->
        <main class="anticode-chat-area">
            <header class="chat-header">
                <div class="header-left">
                    <button id="mobile-menu-toggle" class="mobile-only-btn">☰</button>
                    <span class="channel-hash">#</span>
                    <h1 id="current-channel-name">일상-채팅</h1>
                </div>
                <div class="header-right">
                    <button id="mobile-more-btn" class="mobile-only-btn">⋮</button>
                    <div id="mobile-dropdown-menu" class="mobile-dropdown-content" style="display:none;">
                        <button id="menu-channels">💬 채널 목록</button>
                        <button id="menu-friends">👤 친구 관리</button>
                        <button id="menu-add">➕ 새 채널 생성</button>
                        <button id="menu-members">👥 멤버 목록</button>
                        <button id="menu-profile">⚙️ 프로필 설정</button>
                        <button onclick="toggleNotifSound()" class="notif-toggle-btn notif-sound-toggle">🔔 알림 소리 ON</button>
                    </div>
                    <button id="mobile-members-toggle" class="mobile-only-btn">👥</button>
                    <a href="index.html" class="back-link">블로그로 돌아가기</a>
                </div>
            </header>

            <div id="message-container" class="message-container">
                <div class="chat-welcome">
                    <h1>Anticode에 오신 것을 환영합니다!</h1>
                    <p>커뮤니티의 시작점입니다. 메시지를 남겨보세요.</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <button id="emoji-btn" class="emoji-trigger-btn">😀</button>
                    <button id="attach-btn" class="emoji-trigger-btn">📎</button>
                    <button id="voice-toggle-btn" class="emoji-trigger-btn" title="보이스 톡 (마이크)">🎤</button>
                    <input type="file" id="chat-file-input" accept="image/*,.txt,text/plain,.zip,application/zip,application/x-zip-compressed" style="display:none;">
                    <textarea id="chat-input" placeholder="메시지 보내기..." rows="1"></textarea>

                    <!-- Emoji Picker Popover -->
                    <div id="emoji-picker" class="emoji-picker-popover" style="display:none;">
                        <span class="emoji-item">😀</span><span class="emoji-item">😂</span><span
                            class="emoji-item">🥰</span>
                        <span class="emoji-item">😎</span><span class="emoji-item">🤔</span><span
                            class="emoji-item">👍</span>
                        <span class="emoji-item">❤️</span><span class="emoji-item">🔥</span><span
                            class="emoji-item">✨</span>
                        <span class="emoji-item">🎉</span><span class="emoji-item">😭</span><span
                            class="emoji-item">👀</span>
                    </div>

                    <div class="input-actions">
                        <button id="send-msg-btn">전송</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right: Member List -->
        <aside class="anticode-members">
            <div class="members-header">
                <span>온라인 — <span id="online-count">0</span></span>
            </div>
            <div id="member-list" class="member-list">
                <!-- Member items rendered here -->
            </div>
        </aside>
    </div>


    <!-- Create Channel Modal -->
    <div id="create-channel-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>채널 생성</h2>
            <form id="create-channel-form">
                <div class="form-group">
                    <label>채널 이름</label>
                    <input type="text" id="new-channel-name" required placeholder="예: 축구-채팅">
                </div>
                <div class="form-group">
                    <label>채널 유형</label>
                    <select id="new-channel-type">
                        <option value="notice">📢 공지사항 (공식 알림)</option>
                        <option value="general">일반 채팅</option>
                        <option value="secret">비밀 채팅 (비밀번호)</option>
                        <option value="qna">질문 답변</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>카테고리</label>
                    <select id="new-channel-category">
                        <option value="notice">공지사항</option>
                        <option value="chat">채팅방</option>
                        <option value="karaoke">노래방</option>
                        <option value="voice">보이스 톡</option>
                        <option value="game">게임 방</option>
                    </select>
                </div>
                <div id="password-field-group" class="form-group" style="display:none;">
                    <label>방 비밀번호</label>
                    <input type="password" id="new-channel-password" placeholder="숫자 4자리 권장">
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">생성</button>
                    <button type="button" id="close-channel-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="add-friend-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>친구 추가</h2>
            <form id="add-friend-form">
                <div class="form-group">
                    <label>친구 UID 코드</label>
                    <input type="text" id="friend-uid-input" required placeholder="예: 123456" maxlength="6">
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">추가</button>
                    <button type="button" id="close-friend-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Friend List Modal (Full list + invite) -->
    <div id="friend-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>👤 친구 목록</h2>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">
                친구를 선택해서 현재 채널로 초대할 수 있습니다.
            </p>
            <div id="friend-modal-list"
                style="max-height: 260px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px;">
            </div>
            <div class="modal-btns">
                <button type="button" id="close-friend-list-modal" class="submit-btn">확인</button>
            </div>
        </div>
    </div>

    <!-- Password Entry Modal -->
    <div id="password-entry-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>비밀 채팅방 입장</h2>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">이 방은 비밀번호가 설정되어 있습니다.</p>
            <form id="password-entry-form">
                <div class="form-group">
                    <label>비밀번호</label>
                    <input type="password" id="entry-password-input" required autofocus>
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">입장</button>
                    <button type="button" id="close-password-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>프로필 설정</h2>
            <form id="profile-form">
                <div class="form-group">
                    <label>닉네임</label>
                    <input type="text" id="edit-nickname" required>
                </div>
                <div class="form-group">
                    <label>프로필 이미지</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="url" id="edit-avatar-url" placeholder="https://example.com/photo.jpg"
                            style="flex: 1;">
                        <button type="button" id="upload-avatar-btn" class="sm-btn"
                            style="white-space: nowrap; font-size: 0.7rem;">파일 선택</button>
                    </div>
                    <input type="file" id="avatar-file-input" accept="image/*" style="display:none;">
                    <small style="color: var(--text-muted); font-size: 0.65rem;">직접 올리거나 주소를 입력하세요. (1:1 비율 권장)</small>
                </div>
                <div class="modal-btns">
                    <button type="submit" class="submit-btn">저장</button>
                    <button type="button" id="close-profile-modal" class="cancel-btn">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- App Settings Modal -->
    <div id="app-settings-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>⚙️ 환경 설정</h2>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">🔔 알림 소리</span>
                    <span class="label-desc">새 메시지 도착 시 소리로 알립니다.</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button onclick="toggleNotifSound()" id="notif-toggle-settings" class="notif-toggle-btn notif-sound-toggle">🔔 ON</button>
                    <button type="button" id="notif-os-permission" class="notif-toggle-btn">OS 알림 허용</button>
                    <button type="button" id="notif-test-btn" class="notif-toggle-btn">알림 테스트</button>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-top:10px; width:100%;">
                    <div style="min-width:110px; color:var(--text-muted); font-size:0.75rem; font-weight:700;">알림 볼륨</div>
                    <input id="notif-volume" type="range" min="0" max="100" step="5" value="80" style="flex:1;">
                    <span id="notif-volume-value" style="min-width:48px; text-align:right; color:var(--text-muted); font-size:0.75rem;">80%</span>
                </div>
            </div>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">📲 푸시 알림 (오프라인)</span>
                    <span class="label-desc">브라우저를 완전히 닫아도 OS 푸시 알림을 받습니다. (PC/모바일)</span>
                    <span id="push-status" class="label-desc" style="margin-top:4px;">상태: -</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <button type="button" id="push-enable-btn" class="notif-toggle-btn">푸시 켜기</button>
                    <button type="button" id="push-disable-btn" class="notif-toggle-btn">푸시 끄기</button>
                    <button type="button" id="push-test-btn" class="notif-toggle-btn">푸시 테스트</button>
                </div>
            </div>
            <div id="chat-cleanup-setting" class="setting-item-group" style="display:none;">
                <div class="setting-label">
                    <span class="label-title">🧹 채팅 기록 정리</span>
                    <span class="label-desc">90일(3개월)보다 오래된 메시지를 삭제합니다. (관리자 전용)</span>
                    <span id="chat-cleanup-last-run" class="label-desc" style="margin-top:4px;">마지막 실행: -</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button type="button" id="chat-cleanup-toggle" class="notif-toggle-btn">🔔 ON</button>
                    <button type="button" id="chat-cleanup-run-now" class="notif-toggle-btn">지금 실행</button>
                </div>
            </div>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">🎙️ 마이크(입력 장치)</span>
                    <span class="label-desc">USB 마이크를 재설정/선택할 수 있습니다. (보이스 톡 사용 전 권장)</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center; width:100%;">
                    <select id="voice-mic-select" style="flex:1; min-width: 0;">
                        <option value="">기본 마이크</option>
                    </select>
                    <button type="button" id="voice-mic-refresh" class="notif-toggle-btn">새로고침</button>
                    <button type="button" id="voice-mic-apply" class="notif-toggle-btn">적용</button>
                </div>
            </div>
            <div class="setting-item-group">
                <div class="setting-label">
                    <span class="label-title">🧪 마이크 테스트</span>
                    <span class="label-desc">내 마이크 소리가 들리는지 확인하고(테스트 중에는 스피커로 출력), 입력 레벨을 확인할 수 있습니다.</span>
                </div>
                <div style="display:flex; gap:8px; align-items:center; width:100%; flex-wrap:wrap;">
                    <button type="button" id="voice-mic-test-toggle" class="notif-toggle-btn">테스트 시작</button>
                    <div class="mic-meter" title="마이크 입력 레벨">
                        <div id="voice-mic-meter-bar" class="mic-meter-bar" style="width:0%"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-top:10px; width:100%;">
                    <div style="min-width:110px; color:var(--text-muted); font-size:0.75rem; font-weight:700;">마이크 볼륨</div>
                    <input id="voice-mic-gain" type="range" min="0" max="200" step="5" value="100" style="flex:1;">
                    <span id="voice-mic-gain-value" style="min-width:48px; text-align:right; color:var(--text-muted); font-size:0.75rem;">100%</span>
                </div>
            </div>
            <div class="modal-btns">
                <button type="button" id="close-settings-modal" class="submit-btn">확인</button>
            </div>
        </div>
    </div>

    <!-- Auth Guard -->
    <div id="auth-guard" class="auth-guard" style="display:none;">
        <div class="guard-content">
            <h2>로그인이 필요합니다</h2>
            <p>AntiCode를 이용하시려면 먼저 블로그에 로그인해 주세요.</p>
            <button onclick="location.href='index.html'">로그인하러 가기</button>
        </div>
    </div>

    <!-- Real-time Notification UI -->
    <div id="inapp-notif-toast" class="inapp-notif-toast" style="display:none;">
        <div class="toast-title">Nanodoroshi / Anticode</div>
        <div id="inapp-notif-toast-body" class="toast-body">알림</div>
    </div>
    <div id="notif-badge" class="notif-badge" onclick="clearNotifications()">
        <span class="notif-icon">🔔</span>
        <span id="notif-count-display" class="notif-count" style="display:none;">0</span>
    </div>
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <script type="module" src="anticode.js"></script>
</body>

</html>